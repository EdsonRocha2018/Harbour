
* DATA       : 16/07/97
* PROGRAMA   : RELATFUN.PRG
* COMENTARIO : FUNCOES

FUNCTION T_DIR
KEYBOARD CHR(27)
BUFFER=CHR(4)+CHR(13)

FUNCTION T_ESQ
KEYBOARD CHR(27)
BUFFER=CHR(19)+CHR(13)
 
FUNCTION INDICES
IF .NOT. FILE("EMILD001.NTX") .OR. PCOUNT()<>0
   USE EMILDO  
   MENSAGEM("Organizando o arquivo EMILD001.NTX")
   INDEX ON MATRICULA TO EMILD001
ENDIF
USE
 
FUNCTION BEEP
TONE(250,4)
 
FUNCTION ON_CURSOR
M->GET_VAR=READVAR()
IF LEN(M->GET_VAR)>0 .AND. M->GET_VAR<>"MENU_OPC"
   SET CURSOR ON
ENDIF
 
FUNCTION MENSAGEM
COR_MENS=SETCOLOR()
COR("MENU")
SET CURSOR OFF
IF PCOUNT()=0
   @ 24,11 SAY SPACE(58)
   SETCOLOR(COR_MENS)
   ON_CURSOR()
   RETURN .T.
ENDIF
IF PCOUNT()=1
   PARA TEX_TO
   M->PAUSA=0
ELSE
   PARA TEX_TO,PAUSA
ENDIF
@ 24,11 SAY SPACE(58)
@ 24,((80-LEN(M->TEX_TO))/2) SAY M->TEX_TO
IF M->PAUSA<>0
   M->X=INKEY(M->PAUSA)
ENDIF
SETCOLOR(COR_MENS)
ON_CURSOR()
RETURN .T.
 
FUNCTION PERGUNTA
PER_COR=SETCOLOR()
SET CURSOR OFF
SAVE SCREEN TO PER_TELA
M->RES_POSTA="S"
PARA TEX_TO,RES_POSTA
M->SIM_NAO=IIF(M->RES_POSTA="N",2,1)
M->LAR_G=LEN(M->TEX_TO)
IF M->LAR_G<37
   M->LAR_G=51
ELSE
   M->LAR_G=M->LAR_G+14
ENDIF
COL_SUP=INT((80-M->LAR_G)/2)
COL_INF=COL_SUP+LAR_G-1
JANELA(08,COL_SUP,16,COL_INF)
COR("JANELA DE DIALOGO")
@ 11,(80-LEN(TEX_TO))/2 SAY TEX_TO
BOTAO(13,25,"Sim",1)
BOTAO(13,42,"N„o",2)
SIM_NAO=BOTAO()
RESTORE SCREEN FROM PER_TELA
SETCOLOR(PER_COR)
RETURN IIF(M->SIM_NAO=1,"S","N")

FUNCTION BOTAO
PARA LIN_BOT,COL_BOT,NOM_BOT,NUM_BOT
IF PCOUNT()=0
   NUM_BOT=0
ENDIF
IF PCOUNT()=3
   NUM_BOT=-1
ENDIF
IF PCOUNT()=4
   IF NUM_BOT<1
      Q_BOTOES=1
   ELSE
      Q_BOTOES=NUM_BOT
   ENDIF
   BOTOES[Q_BOTOES]=STR(COL_BOT,3)+STR(LIN_BOT,3)+NOM_BOT
ENDIF
IF PCOUNT()=1
   X_BOT=LIN_BOT
   NUM_BOT=0
ELSE
   X_BOT=1
ENDIF
IF NUM_BOT>0 .OR. NUM_BOT=-1
   COR("BOTOES")
   @ LIN_BOT,COL_BOT SAY SPACE(11)
   @ LIN_BOT,COL_BOT+1 SAY NOM_BOT
   SETCOLOR("N/"+ALLTRIM(SUBS(CONTECOR[4],4)))
   @ LIN_BOT,COL_BOT-1 SAY "Ü"
   @ LIN_BOT+1,COL_BOT-1 SAY "ßßßßßßßßßßß "
ELSE
   TECLA=0
   DO WHILE .T.
      COL_BOT=VAL(SUBS(BOTOES[X_BOT],1,3))
      LIN_BOT=VAL(SUBS(BOTOES[X_BOT],4,3))
      NOM_BOT=SUBS(BOTOES[X_BOT],7)
      COR("BOTAO EM DESTAQUE")
      @ LIN_BOT,COL_BOT SAY SPACE(11)
      @ LIN_BOT,COL_BOT+1 SAY NOM_BOT
      SETCOLOR("N/"+ALLTRIM(SUBS(CONTECOR[4],4)))
      @ LIN_BOT,COL_BOT-1 SAY "Ü"
      @ LIN_BOT+1,COL_BOT-1 SAY "ßßßßßßßßßßß "
      IF TECLA=13
         INKEY(.2)
         RETURN X_BOT
      ENDIF
      IF NUM_BOT=-2
         TECLA=13
      ELSE
         TECLA=INKEY(0)
      ENDIF
      IF TECLA=27
         RETURN 0
      ENDIF
      COR("BOTOES")
      @ LIN_BOT,COL_BOT+1 SAY NOM_BOT
      FOR F_BOT=1 TO Q_BOTOES
         IF SUBS(BOTOES[F_BOT],7,1)=UPPER(CHR(TECLA))
            X_BOT=F_BOT
            TECLA=13
            COL_BOT=VAL(SUBS(BOTOES[X_BOT],1,3))
            LIN_BOT=VAL(SUBS(BOTOES[X_BOT],4,3))
            NOM_BOT=SUBS(BOTOES[X_BOT],7)
            EXIT
         ENDIF
      NEXT
      IF TECLA=13
         COR("JANELA DE DIALOGO")
         @ LIN_BOT,COL_BOT SAY " "
         @ LIN_BOT+1,COL_BOT-1 SAY "            "
         @ LIN_BOT,COL_BOT+10 SAY " "
         COR("BOTAO EM DESTAQUE")
         @ LIN_BOT,COL_BOT-1 SAY " "+NOM_BOT+" "
         INKEY(.2)
         LOOP
      ENDIF
      IF TECLA=19 .OR. TECLA=5
         X_BOT=X_BOT-1
      ELSEIF TECLA=4 .OR. TECLA=24
         X_BOT=X_BOT+1
      ENDIF
      X_BOT=IIF(X_BOT<1,Q_BOTOES,IIF(X_BOT>Q_BOTOES,1,X_BOT))
   ENDDO
ENDIF
 
FUNCTION FUN_ACHO
PARA PAR1,PAR2,PAR3
M->TEC_ACHO=UPPER(CHR(LASTKEY()))
IF (M->TEC_ACHO>="A" .AND. M->TEC_ACHO<="Z") .OR. (M->TEC_ACHO>="0" .AND. M->TEC_ACHO<="9")
   FOR M->X_ACHO=1 TO LEN(ME_NU)
      FOR M->ACHO_X=1 TO LEN(ME_NU[M->X_ACHO])
         IF (SUBS(ME_NU[M->X_ACHO],M->ACHO_X,1)>="A" .AND. SUBS(ME_NU[M->X_ACHO],M->ACHO_X,1)<="Z") .OR. (SUBS(ME_NU[M->X_ACHO],M->ACHO_X,1)>="0" .AND. SUBS(ME_NU[M->X_ACHO],M->ACHO_X,1)<="9")
            IF SUBS(ME_NU[M->X_ACHO],M->ACHO_X,1) = M->TEC_ACHO
               M->OPC_ACHO = M->X_ACHO
               RETURN 0
            ENDIF
            EXIT
         ENDIF
      NEXT
   NEXT
ENDIF
IF LASTKEY()=13
   M->INC_COL=ROW()
   RETURN 1
ELSEIF LASTKEY()=27 .OR. M->TEC_ACHO="R"
   RETURN 0
ELSEIF PAR1=1
   KEYBOARD CHR(30)
ELSEIF PAR1=2
   KEYBOARD CHR(31)
ENDIF
RETURN 2
 
FUNCTION MENU
PARA N_TELA
IF PCOUNT()=0
   N_TELA=0
   SET KEY  4 TO T_DIR
   SET KEY 19 TO T_ESQ
ENDIF
M->M_POS=MENU_POS[M->MENU_P]
M->LIN_INIC=LIN_MENU+1
IF N_TELA=1 .OR. N_TELA=2
   M->M_POS=M->M_POS+10
   IF N_TELA=1
      M->LIN_INIC=LIN_MENU+MENU_S+2
   ELSE
      M->LIN_INIC=LIN_MENU+2
   ENDIF
ENDIF
M->LAR_G=0
M->AL_TU=LEN(ME_NU)
DECLARE MEN_U[M->AL_TU] , MAR_C[M->AL_TU]
AFILL(MAR_C,.T.)
FOR M->X_X=1 TO M->AL_TU
   MEN_U[M->X_X]=" "+TRIM(ME_NU[M->X_X])+" "
   IF LEN(MEN_U[M->X_X]) > M->LAR_G
      M->LAR_G=LEN(MEN_U[M->X_X])
      IF SUBS(MEN_U[M->X_X],2,1)=">"
         M->LAR_G=M->LAR_G+1
      ENDIF
   ENDIF
NEXT
IF M->LAR_G < 18
   M->LAR_G=18
ENDIF
FOR M->X_X=1 TO M->AL_TU
   IF MEN_U[M->X_X]=" - "
      MAR_C[M->X_X]=.F.
      MEN_U[M->X_X]=REPL("Ä",M->LAR_G)
   ENDIF
   IF SUBS(MEN_U[M->X_X],2,1)=">"
      MEN_U[M->X_X]=" "+SUBS(MEN_U[M->X_X],3)+SPACE((M->LAR_G-LEN(ALLTRIM(MEN_U[M->X_X])))-3)+CHR(16)+" "
   ENDIF
NEXT
M->AL_TU=M->AL_TU+2
IF M->AL_TU>15
   M->AL_TU=15
ENDIF
M->ULT_OPC=M->AL_TU
IF M->M_POS + M->LAR_G + 3 > 79
   IF M->N_TELA=0
      M->M_POS = M->M_POS - ((M->LAR_G+2) - LEN(MENU_PRI[M->MENU_P]))
   ELSE
      M->M_POS = M->M_POS - ((M->M_POS+M->LAR_G+3)-79)
   ENDIF
ENDIF
M->X_X=M->M_POS+M->LAR_G+2
COR("MENU")
@ M->LIN_INIC,M->M_POS CLEAR TO M->AL_TU+M->LIN_INIC-1,M->M_POS+M->LAR_G+3
@ M->LIN_INIC,M->M_POS+1 TO M->AL_TU+M->LIN_INIC-1,M->M_POS+M->LAR_G+2
IF M->AL_TU<15
   FOR M->X_X=1 TO M->AL_TU-2
      IF SUBS(MEN_U[M->X_X],1,1)="Ä"
         @ M->X_X+M->LIN_INIC,M->M_POS+1 SAY "Ã"
         @ M->X_X+M->LIN_INIC,M->M_POS+M->LAR_G+2 SAY "´"
      ENDIF
   NEXT
ENDIF
IF LEN(MEN_U) > M->AL_TU-2
   @ M->LIN_INIC+1,M->M_POS+M->LAR_G+3 SAY CHR(24)
   @ M->LIN_INIC+M->AL_TU-2,M->M_POS+M->LAR_G+3 SAY CHR(25)
ENDIF
M->OPC_ACHO=0
M->MENU_OPC=ACHOICE(M->LIN_INIC+1,M->M_POS+2,M->LIN_INIC+M->AL_TU-2,M->M_POS+M->LAR_G+1,MEN_U,MAR_C,"FUN_ACHO")
IF M->MENU_OPC=0
   M->MENU_OPC = M->OPC_ACHO
   IF N_TELA=0 .AND. BUFFER=CHR(13) .AND. M->MENU_OPC=0
      BUFFER="S"+CHR(13)
   ENDIF
ENDIF
IF MENU_OPC<>0
   IF .NOT.(N_TELA=0 .AND. SUBS(MEN_U[MENU_OPC],LEN(MEN_U[MENU_OPC])-1,1)=CHR(16))
      RESTSCREEN(LIN_MENU+1,00,23,79,TELA_PRI)
   ELSE
      IF LEN(MEN_U) <= M->AL_TU
         COR("DESTAQUE DO MENU")
         @ LIN_MENU+MENU_OPC+1,COL() SAY MEN_U[MENU_OPC]
      ENDIF
   ENDIF
ELSE
   RESTSCREEN(LIN_MENU+1,00,23,79,TELA_PRI)
ENDIF
SET KEY  4 TO
SET KEY 19 TO
RETURN M->MENU_OPC
 
FUNCTION COR
PARA NOM_COR
QUAL_COR=ASCAN(NOMECOR,UPPER(NOM_COR))
IF QUAL_COR<>0
   IF QUAL_COR=2
      SETCOLOR(CONTECOR[2]+","+CONTECOR[3]+",,,"+CONTECOR[2])
   ELSEIF QUAL_COR=8
      SETCOLOR(CONTECOR[11]+","+CONTECOR[9]+",,,"+CONTECOR[8])
   ELSE
      SETCOLOR(CONTECOR[QUAL_COR])
   ENDIF
ENDIF
RETURN .T.

FUNCTION FUN_CFG
PARA PAR1
IF LASTKEY()=13
   RETURN 1
ELSEIF LASTKEY()=27
   RETURN 0
ELSEIF PAR1=1
   KEYBOARD CHR(30)
ELSEIF PAR1=2
   KEYBOARD CHR(31)
ENDIF
CFG_COR=SETCOLOR()
COR("MENU")
FOR F_CFG=1 TO LEN(MENU_CFG)
   @ 09+F_CFG,34 SAY " "
NEXT
SETCOLOR(CFG_COR)
RETURN 2
 
FUNCTION MENU_PRN
PARA ARQ_PRN
JANELA(06,21,18,59,"Saidas")
COR("MENU")
@ 09,26 CLEAR TO 13,54
DO WHILE .T.
   BOTAO(15,35,"Enter")
   DECLARE MENU_CFG[3]
   MENU_CFG[1]="     ("+CHR(7)+") Impressora"
   MENU_CFG[2]="     ("+CHR(7)+") Tela      "
   MENU_CFG[3]="     ("+CHR(7)+") Arquivo   "
   SETCOLOR(CONTECOR[2]+","+CONTECOR[7])
   KEYBOARD CHR(32)
   M->OPC_PRN=ACHOICE(10,28,12,52,MENU_CFG,.T.,"FUN_CFG")
   IF M->OPC_PRN<>0
      BOTAO(15,35,"Enter",-2)
   ENDIF
   IF M->OPC_PRN=0
      RETURN .F.
   ELSEIF M->OPC_PRN = 1
      M->TIPO_PRN = "I"
      IF .NOT. ISPRINTER()
         BEEP()
         MENSAGEM("Impressora desligada ou desconectada",3)
         MENSAGEM("Tecle <ESC> para sair")
         LOOP
      ENDIF
   ELSEIF M->OPC_PRN = 2
      M->TIPO_PRN = "T"
      ARQ_PRN=ARQ_PRN+".$TX"
      SET PRINTER TO &ARQ_PRN
   ELSEIF M->OPC_PRN = 3
      JANELA(06,17,18,65,"Saidas")
      COR("MENU")
      @ 09,21 CLEAR TO 15,61
      @ 11,23 SAY " Digite o nome do arquivo de saida "
      ARQ_PRN=SPACE(8)
      DO WHILE .T.
         COR("GET")
         @ 13,35 GET ARQ_PRN PICT "@!" VALID ISALPHA(ARQ_PRN)
         SET CURSOR ON
         READ
         SET CURSOR OFF
         IF LASTKEY()=27
            RETURN .F.
         ENDIF
         IF AT(".",ARQ_PRN)<>0
            BEEP()
            MENSAGEM("Digite o nome do arquivo sem extens„o",3)
            MENSAGEM("Tecle <ESC> para sair")
            LOOP
         ENDIF
         EXIT
      ENDDO
      ARQ_PRN=ARQ_PRN+".TXT"
      M->TIPO_PRN = "A"
      SET PRINTER TO &ARQ_PRN
   ENDIF
   MENSAGEM("Tecle <ESC> para pausa ou interrup‡„o")
   RETURN .T.
ENDDO
 
FUNCTION IMP_TELA
PARA ARQ_PRN,TAM_LIN,MARG_ESQ
IF PCOUNT()=2
   M->MARG_ESQ=0
ENDIF
M->MARG_ESQ=M->MARG_ESQ+1
MENSAGEM("Aguarde processamento")
SELE 100
PUBL QUAN_REG,ULT_POS
M->ARQ_PRN1=M->ARQ_PRN+".$TX"
M->ARQ_PRN2=M->ARQ_PRN+".$AQ"
CREATE ARQ_STRU
USE ARQ_STRU
APPE BLANK
REPLACE FIELD_NAME WITH "LI_NHA",FIELD_TYPE WITH "C"
REPLACE FIELD_LEN  WITH M->TAM_LIN+1,FIELD_DEC WITH 0
CREATE &ARQ_PRN2 FROM ARQ_STRU
USE
ERASE ARQ_STRU.DBF
USE &ARQ_PRN2
APPEND FROM &ARQ_PRN1 SDF
M->QUAN_REG=LASTREC()
IF M->QUAN_REG=0
   M->QUAN_REG=1
ENDIF
GOTO TOP
JANELA(LIN_MENU+5,02,21,77)
@ LIN_MENU+4,77 SAY CHR(30)
@ 20,77 SAY CHR(31)
IF M->TAM_LIN<72
   DECLARE EDI_TAR[1]
   EDI_TAR[1]="SUBS(LI_NHA,M->MARG_ESQ)"
ELSE
   IF INT(M->TAM_LIN/36)=M->TAM_LIN/36
      M->NUM_COL=M->TAM_LIN/36
   ELSE
      M->NUM_COL=INT(M->TAM_LIN/36)+1
   ENDIF
   DECLARE EDI_TAR[M->NUM_COL]
   M->X=1
   DO WHILE M->X<M->NUM_COL
      M->NUM_MAT=(M->X*36)-34
      EDI_TAR[M->X]="SUBS(LI_NHA,"+STR(M->NUM_MAT,3)+",36)"
      M->X=M->X+1
   ENDDO
   M->NUM_MAT=(M->X*36)-34
   EDI_TAR[M->X]="SUBS(LI_NHA,"+STR(M->NUM_MAT,3)+")+SPACE("+STR((M->NUM_COL*36)-M->TAM_LIN,2)+")"
ENDIF
KEYBOARD CHR(65)
M->ULT_POS=LIN_MENU+5
MENSAGEM("Tecle <ESC> para sair")
SETCOLOR(CONTECOR[4]+","+CONTECOR[7])
DBEDIT(LIN_MENU+4,04,20,75,EDI_TAR,"FUN_IMP","","","","")
USE
ERASE &ARQ_PRN1
ERASE &ARQ_PRN2
RELEASE QUAN_REG,ULT_POS

FUNCTION FUN_IMP
IF LASTKEY()=27
   RETURN 0
ELSEIF LASTKEY()=1
   GOTO TOP
ELSEIF LASTKEY()=6
   GOTO BOTT
ENDIF
COR("BOX DA JANELA DE DIALOGO")
@ M->ULT_POS,77 SAY " "
M->ULT_POS=LIN_MENU+5+(((RECN()*100)/M->QUAN_REG)/(100/(19-(LIN_MENU+5))))
IF RECN()=1
   M->ULT_POS=LIN_MENU+5
ENDIF
@ M->ULT_POS,77 SAY CHR(4)
SETCOLOR(CONTECOR[4]+","+CONTECOR[7])
set color to w+/b,n/w,n,w+
RETURN 1

FUNCTION JANELA
PARA PJAN1,PJAN2,PJAN3,PJAN4,PJAN5
IF PCOUNT()<>5
   PJAN5=""
ENDIF
SETCOLOR(CONTECOR[4])
@ PJAN1,PJAN2 CLEAR TO PJAN3,PJAN4
SETCOLOR(CONTECOR[5])
@ PJAN1,PJAN2,PJAN3,PJAN4 BOX " "
@ PJAN1,PJAN2 SAY "þ"
IF LEN(TRIM(PJAN5)) > 0
   @ PJAN1,PJAN2+(((PJAN4+1-PJAN2)-LEN(PJAN5))/2) SAY PJAN5
ENDIF

FUNCTION PADRAO
CONTECOR[01]="15/01"
CONTECOR[02]="00/07"
CONTECOR[03]="15/06"
CONTECOR[04]="07/01"
CONTECOR[05]="00/03"
CONTECOR[06]="00/07"
CONTECOR[07]="15/07"
CONTECOR[08]="00/07"
CONTECOR[09]="15/04"
CONTECOR[10]="15/01"
CONTECOR[11]="07/01"
CONTECOR[12]="07/01"
RETURN .T.

FUNCTION PERG
COR("MENU")
SET CURSOR OFF
M->RES_POSTA="S"
PARA TEX_TO,RES_POSTA
M->SIM_NAO=IIF(M->RES_POSTA="N",2,1)
@ 24,11 SAY SPACE(58)
M->LI=(80-(LEN(M->TEX_TO)+11))/2
@ 24,M->LI SAY M->TEX_TO
M->LI=M->LI+LEN(M->TEX_TO)+2
DO WHILE .T.
   @ 24,M->LI   PROMPT "Sim"
   @ 24,M->LI+6 PROMPT "N„o"
   @ 24,M->LI+4 SAY "-"
   MENU TO M->SIM_NAO
   IF M->SIM_NAO<>0
      EXIT
   ENDIF
ENDDO
ON_CURSOR()
RETURN IIF(M->SIM_NAO=1,"S","N")

/*
Fun‡Æo:   Posicione 
Descri‡Æo:Funcao para posicionamento e retorno de um campo de 1 arq. 
Sintaxe:  Posicione(Alias,Ordem,Expressao,Campo)
Campo =  a ser retornado				  
*/
Function Posicione(cAlias,nOrdem,cExpr,cCpo)
Local cSavAlias := Alias(), cRet

DbSelectArea(cAlias)
DbSetOrder(nOrdem)
DbSeek(cExpr)

cRet := &(cCpo)
DbSelectArea(cSavAlias)
Return cRet  

* Final do programa RELATFUN.PRG
